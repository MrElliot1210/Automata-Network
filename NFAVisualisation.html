<!DOCTYPE html>
<html>
    <head>
        <title>Automata Network - NFA Visualisation</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.33.1/cytoscape.min.js"></script>
    </head>
    <body>
        <h1>Automata Network</h1>
        <button onclick="window.location.assign('index.html');">Back To Homepage</button>
        <h2>Visualise NFA</h2>
        <p><u><b>Instructions:</b></u></p>
        <ul>
            <li>Click and drag nodes to move them around.</li>
            <li>Click and drag the background to move the view around.</li>
            <li>Scroll to zoom in and out.</li>
        </ul>

        <div style="display: flex;">
            <div id="cy" style="width: 640px; height: 480px; border-style: solid;"></div>
            <div style="margin-left: 5px;">
                <p><u><b>Key:</b></u></p>
                <ul>
                    <li><span style="border-style: solid;">Square</span> node shape: Initial state</li>
                    <br>
                    <li><span style="background-color: #99ff99;">Green</span> fill colour: Final state</li>
                </ul>
            </div>
        </div>

        <script>
            var cy = cytoscape({
                container: document.getElementById("cy"),

                style: [
                    {
                        selector: "node",
                        style: {
                            "background-color": "white",
                            "label": "data(id)",
                            "font-weight": "bold",
                            "border-style": "solid",
                            "border-color": "black",
                            "border-width": 2,
                            "text-valign": "center",
                            "width": 45
                        }
                    },
                    {
                        selector: "edge",
                        style: {
                            "width": 3,
                            "line-color": "#ccc",
                            "target-arrow-color": "#ccc",
                            "target-arrow-shape": "triangle",
                            "curve-style": "bezier",
                            "label": "data(label)",
                            "text-background-color": "#ccc",
                            "text-background-opacity": 1,
                            "text-background-shape": "circle",
                            "text-background-padding": "5px",
                            "control-point-step-size": 60
                        }
                    },
                    {
                        selector: "#q1",
                        style: {
                            "shape": "rectangle"
                        }
                    },
                    {
                        selector: ".final",
                        style: {
                            "background-color": "#99ff99"
                        }
                    }
                ]
            });

            const nfa = JSON.parse(sessionStorage.getItem("nfa"));
            console.log(nfa);

            // add states
            for (const state of nfa.states) {
                let node = {};
                node["data"] = {};
                node["data"]["id"] = state;
                cy.add(node);
            }

            // add transitions
            for (const state of nfa.states) {
                for (const symbol of nfa.alphabet) {
                    for (const transition of nfa.transitionFunction[state][symbol]) {
                        // these nested for loops ensures there is actually a transition and we are not making any incomplete objects
                        let edge = {};
                        edge["data"] = {};
                        edge["data"]["id"] = state + symbol + transition;
                        edge["data"]["source"] = state;
                        edge["data"]["label"] = symbol;
                        edge["data"]["target"] = transition;
                        cy.add(edge);
                    }
                }
                // don't forget Îµ!
                for (const transition of nfa.transitionFunction[state]["\u03B5"]) {
                    let edge = {};
                    edge["data"] = {};
                    edge["data"]["id"] = state + "\u03B5" + transition;
                    edge["data"]["source"] = state;
                    edge["data"]["label"] = "\u03B5";
                    edge["data"]["target"] = transition;
                    cy.add(edge);
                }
            }

            // specify final states
            for (const state of nfa.finalStates) {
                cy.$("#" + state).addClass("final");
            }

            // layout must be refreshed after adding nodes
            var layout = cy.layout({ name: 'circle' });
            layout.run();
        </script>

    </body>
</html>